{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Music Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 150px; /* –°–æ–∑–¥–∞–µ–º –º–µ—Å—Ç–æ –¥–ª—è –ø–ª–µ–µ—Ä–∞ –≤–Ω–∏–∑—É */
        }
        .album-card {
            transition: transform .2s;
        }
        .album-card:hover {
            transform: scale(1.02);
        }
        .audio-player {
            width: 110%;
            margin-top: 10px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4"> /* –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        <div class="container">
            <a class="navbar-brand ajax-link" href="{% url 'home' %}">üéµ MusicHub</a>
            <form class="d-flex mx-auto" id="search-form" action="{% url 'search' %}" method="GET" style="width: 50%;">
                <input class="form-control me-2" type="search" placeholder="–ù–∞–π—Ç–∏ –ø–ª–µ–π–ª–∏—Å—Ç—ã, —Ç—Ä–µ–∫–∏ –∏–ª–∏ —Ç–µ–≥–∏..."
                       aria-label="Search" name="q" value="{{ request.GET.q }}">
                <button class="btn btn-outline-light" type="submit">–ù–∞–π—Ç–∏</button>
            </form>
            <div class="d-flex">
                {% if user.is_authenticated %}
                    <span class="navbar-text me-3">–ü—Ä–∏–≤–µ—Ç, {{ user.username }}!</span>
                    <a href="{% url 'create_playlist' %}" class="btn btn-outline-light me-2">–°–æ–∑–¥–∞—Ç—å –ø–ª–µ–π–ª–∏—Å—Ç</a>
                    <a href="{% url 'logout' %}" class="btn btn-secondary">–í—ã–π—Ç–∏</a>
                {% else %}
                    <a href="{% url 'login' %}" class="btn btn-outline-light me-2">–í–æ–π—Ç–∏</a>
                    <a href="{% url 'signup' %}" class="btn btn-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
                {% endif %}
            </div>
        </div>
    </nav>

<main class="container">
    <div id="main-content">
        {% block content %}{% endblock %}
    </div>
</main>

<div class="player-container fixed-bottom bg-dark text-white p-3"> /* –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–π –ø–ª–µ–µ—Ä */
    <div class="row align-items-center">
        <div class="col-md-3 d-flex align-items-center">
            <img id="player-album-cover" src="https://via.placeholder.com/64" alt="Album Cover" class="img-fluid me-3" style="width: 64px; height: 64px;">
            <div>
                <h6 id="player-song-title" class="mb-0">–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–µ–∫</h6>
                <small id="player-artist" class="text-muted">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</small>
            </div>
        </div>

        <div class="col-md-6">
            <div class="d-flex justify-content-center align-items-center mb-2">
                <button id="prev-btn" class="btn btn-outline-light border-0"><i class="fas fa-step-backward"></i></button>
                <button id="play-pause-btn" class="btn btn-light rounded-circle mx-3 p-2" style="width: 48px; height: 48px;"><i class="fas fa-play"></i></button>
                <button id="next-btn" class="btn btn-outline-light border-0"><i class="fas fa-step-forward"></i></button>
            </div>
            <div class="d-flex align-items-center">
                <span id="current-time" class="me-2" style="font-size: 0.8rem;">0:00</span>
                <input type="range" id="progress-bar" class="form-range" value="0" step="1" style="flex-grow: 1;">
                <span id="duration" class="ms-2" style="font-size: 0.8rem;">0:00</span>
            </div>
        </div>

        <div class="col-md-3 d-flex justify-content-end align-items-center">
            <i class="fas fa-volume-up me-2"></i>
            <input type="range" id="volume-bar" class="form-range w-50" min="0" max="1" step="0.01" value="1">
        </div>
    </div>
    <audio id="main-player" class="d-none"></audio>
</div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const musicPlayer = {
        // Player elements that are always on the page
        player: null,
        playPauseBtn: null,
        playIcon: '<i class="fas fa-play"></i>',
        pauseIcon: '<i class="fas fa-pause"></i>',
        nextBtn: null,
        prevBtn: null,
        albumCover: null,
        songTitle: null,
        artistName: null,
        progressBar: null,
        currentTimeEl: null,
        durationEl: null,
        volumeBar: null,

        // Player state
        currentPlaylist: [],
        currentTrackIndex: -1,

        /**
         * init(): –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–ª–µ–µ—Ä–∞ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç –∫ –Ω–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
         * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
         */
        init: function() {
            this.player = document.getElementById('main-player');
            this.playPauseBtn = document.getElementById('play-pause-btn');
            this.nextBtn = document.getElementById('next-btn');
            this.prevBtn = document.getElementById('prev-btn');
            this.albumCover = document.getElementById('player-album-cover');
            this.songTitle = document.getElementById('player-song-title');
            this.artistName = document.getElementById('player-artist');
            this.progressBar = document.getElementById('progress-bar');
            this.currentTimeEl = document.getElementById('current-time');
            this.durationEl = document.getElementById('duration');
            this.volumeBar = document.getElementById('volume-bar');

            // Attach listeners to player controls
            this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
            this.nextBtn.addEventListener('click', () => this.playNext());
            this.prevBtn.addEventListener('click', () => this.playPrev());
            this.player.addEventListener('timeupdate', () => this.updateProgressBar());
            this.player.addEventListener('ended', () => this.playNext());
            this.progressBar.addEventListener('input', () => this.seek());
            this.volumeBar.addEventListener('input', (e) => this.player.volume = e.target.value);
        },

        /**
         * reinitializeSongLinks(): –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç—Ä–µ–∫–∏
         * –∏ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç –∫ –∫–ª–∏–∫—É –º—ã—à–∫–∏ –¥–ª—è –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–Ω–∏—è —Ç—Ä–µ–∫–∞
         * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π —Ä–∞–∑, –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ AJAX-–∑–∞–ø—Ä–æ—Å–∞—Ö
         */
        reinitializeSongLinks: function() {
            // –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
            // –≠—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –ø—Ä–∏ AJAX-–Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            document.querySelectorAll('.song-link').forEach(link => {
                const newLink = link.cloneNode(true);
                link.parentNode.replaceChild(newLink, link);
            });

            // –¢–µ–ø–µ—Ä—å –≤–µ—à–∞–µ–º —Å–≤–µ–∂–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞ "—á–∏—Å—Ç—ã–µ" —Å—Å—ã–ª–∫–∏
            document.querySelectorAll('.song-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();

                    const albumId = link.dataset.albumId;
                    let songListElements = null;

                    // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ –ø–ª–µ–π–ª–∏—Å—Ç –ø–æ ID (–∫–∞–∫ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–ª–µ–π–ª–∏—Å—Ç–∞)
                    if (albumId) {
                        songListElements = document.querySelectorAll(`#playlist-${albumId} .song-link`);
                    }

                    // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ (–º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –ø–æ–∏—Å–∫–∞),
                    // –∏—â–µ–º –≤—Å–µ —Ç—Ä–µ–∫–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–º <ul>
                    if (!songListElements || songListElements.length === 0) {
                        const parentList = link.closest('ul');
                        if (parentList) {
                            songListElements = parentList.querySelectorAll('.song-link');
                        } else {
                            // –ï—Å–ª–∏ –∏ <ul> –Ω–µ—Ç, —Ç–æ –ø–ª–µ–π–ª–∏—Å—Ç –±—É–¥–µ—Ç —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 1 —Ç—Ä–µ–∫–∞
                            songListElements = [link];
                        }
                    }

                    // –°—Ç—Ä–æ–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–ª–µ–π–ª–∏—Å—Ç –ø–ª–µ–µ—Ä–∞ –∏–∑ —Ç–æ–≥–æ, —á—Ç–æ –Ω–∞—à–ª–∏
                    this.currentPlaylist = Array.from(songListElements).map(linkEl => ({
                        src: linkEl.dataset.src,
                        title: linkEl.dataset.title,
                        artist: linkEl.dataset.artist,
                        cover: linkEl.dataset.cover,
                        linkElement: linkEl
                    }));

                    // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –∫–ª–∏–∫–Ω—É—Ç–æ–≥–æ —Ç—Ä–µ–∫–∞ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
                    const clickedIndex = this.currentPlaylist.findIndex(track => track.src === link.dataset.src);
                    this.playTrack(clickedIndex);
                });
            });
        },

        // –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–ª–µ–µ—Ä–∞
        playTrack: function(index) {
            if (index < 0 || index >= this.currentPlaylist.length) return;

            const track = this.currentPlaylist[index];
            this.player.src = track.src;
            this.songTitle.textContent = track.title;
            this.artistName.textContent = track.artist;
            this.albumCover.src = track.cover;

            this.player.play();
            this.playPauseBtn.innerHTML = this.pauseIcon;
            this.currentTrackIndex = index;
            this.updateActiveLink();
        },

        togglePlayPause: function() {
            if (this.player.paused) {
                if (this.currentTrackIndex === -1 && this.currentPlaylist.length > 0) {
                    this.playTrack(0);
                } else {
                    this.player.play();
                }
                this.playPauseBtn.innerHTML = this.pauseIcon;
            } else {
                this.player.pause();
                this.playPauseBtn.innerHTML = this.playIcon;
            }
        },

        playNext: function() {
            if (this.currentPlaylist.length === 0) return;
            const newIndex = (this.currentTrackIndex + 1) % this.currentPlaylist.length;
            this.playTrack(newIndex);
        },

        playPrev: function() {
            if (this.currentPlaylist.length === 0) return;
            const newIndex = (this.currentTrackIndex - 1 + this.currentPlaylist.length) % this.currentPlaylist.length;
            this.playTrack(newIndex);
        },

        // --- UI Update Methods ---
        updateProgressBar: function() {
            if (this.player.duration) {
                this.progressBar.value = (this.player.currentTime / this.player.duration) * 100;
                this.currentTimeEl.textContent = this.formatTime(this.player.currentTime);
                this.durationEl.textContent = this.formatTime(this.player.duration);
            }
        },

        seek: function() {
            if (this.player.duration) {
                this.player.currentTime = (this.progressBar.value / 100) * this.player.duration;
            }
        },

        formatTime: function(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        },

        updateActiveLink: function() {
            document.querySelectorAll('.song-link.active').forEach(link => link.classList.remove('active'));
            if (this.currentTrackIndex !== -1) {
                this.currentPlaylist[this.currentTrackIndex].linkElement.classList.add('active');
            }
        }
    };


    // –≠—Ç–∞ —á–∞—Å—Ç—å –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫—É—é –ø–æ–¥–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–ª–µ–µ—Ä–∞ –∫–∞–∫ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–≥—Ä—É–∑–∏–ª–∞—Å—å.
        // –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–¥–∏–Ω —Ä–∞–∑
        musicPlayer.init();
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç—Ä–µ–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π
        musicPlayer.reinitializeSongLinks();

        const mainContent = document.getElementById('main-content');
        const searchForm = document.getElementById('search-form');

        async function loadContent(url) {
            try {
                const response = await fetch(url, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                const html = await response.text();
                mainContent.innerHTML = html;
                window.history.pushState({path: url}, '', url);

                // –ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –º—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ–≥–æ.
                musicPlayer.reinitializeSongLinks();

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', error);
                window.location.href = url; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –æ–±—ã—á–Ω–æ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            }
        }

        document.body.addEventListener('click', function(event) {
            const link = event.target.closest('.ajax-link');
            if (link) {
                event.preventDefault();
                loadContent(link.href);
            }
        });

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞
        searchForm.addEventListener('submit', function(event) {
            event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É

            // –°–æ–±–∏—Ä–∞–µ–º URL –¥–ª—è AJAX-–∑–∞–ø—Ä–æ—Å–∞
            const query = this.querySelector('input[name="q"]').value;
            const url = new URL(this.action); // –ë–µ—Ä–µ–º action –∏–∑ —Ñ–æ—Ä–º—ã (—Ç.–µ. /search/)
            url.searchParams.set('q', query); // –î–æ–±–∞–≤–ª—è–µ–º ?q=...

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ø–æ–º–æ—â—å—é –Ω–∞—à–µ–π AJAX-—Ñ—É–Ω–∫—Ü–∏–∏
            loadContent(url.href);
        });

        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.path) {
                loadContent(event.state.path);
            }
        });
    });
</script>

<style>
    .song-link.active {
        font-weight: bold;
        color: #0d6efd; /* –¶–≤–µ—Ç Bootstrap Primary */
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>